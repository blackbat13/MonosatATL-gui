<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MsATL</title>
    <script>if (typeof module === 'object') {
        window.module = module;
        module = undefined;
    }</script>
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/jquery-ui-dist/jquery-ui.min.js"></script>
    <script>if (window.module) module = window.module;</script>
    <link href="css/main.css" type="text/css" rel="stylesheet"/>
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" type="text/css" rel="stylesheet"/>
    <link href="node_modules/font-awesome/css/font-awesome.min.css" type="text/css" rel="stylesheet">
    <link href="node_modules/jquery-ui-dist/jquery-ui.min.css" type="text/css" rel="stylesheet">
    <link href="node_modules/jquery-ui-dist/jquery-ui.theme.min.css" type="text/css" rel="stylesheet">
    <link href="node_modules/material-icons/iconfont/material-icons.css" type="text/css" rel="stylesheet">
    <link href="node_modules/mdbootstrap/css/mdb.min.css" type="text/css" rel="stylesheet">
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="node_modules/d3/dist/d3.js"></script>
    <script src="node_modules/lodash/lodash.min.js"></script>
</head>
<body>
<div class="container-fluid">
    <!-- Modal -->
    <div id="resultModal" class="modal fade">
        <div class="modal-dialog modal-confirm">
            <div class="modal-content">
                <div class="modal-header-success">
                    <div class="icon-box">
                        <i class="material-icons">&#xE876;</i>
                    </div>
                    <!--                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>-->
                </div>
                <div class="modal-body text-center">
                    <h4>Results</h4>
                    <p>
                                                <span class="result-span display_none" id="SAT">
                                                    The formula is <span class="bold">SATISFIABLE</span> under given constraints. <br/>A model has been found.
                                                </span>
                        <span class="result-span display_none" id="UNSAT">
                                                    The formula is <span class="bold">UNSATISFIABLE</span> under given constraints.
                                                </span>
                    </p>
                    <button class="btn btn-success" data-dismiss="modal"><span>Close</span></button>
                </div>
            </div>
        </div>
    </div>
    <!--    <div class="modal fade" id="resultModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"-->
    <!--         aria-hidden="true">-->
    <!--        <div class="modal-dialog" role="document">-->
    <!--            <div class="modal-content">-->
    <!--                <div class="modal-header">-->
    <!--                    <h5 class="modal-title">Results</h5>-->
    <!--                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">-->
    <!--                        <span aria-hidden="true">&times;</span>-->
    <!--                    </button>-->
    <!--                </div>-->
    <!--                <div class="modal-body">-->
    <!--                    <p>-->
    <!--                        <span class="result-span display_none" id="SAT">-->
    <!--                            The formula is <span class="bold">SATISFIABLE</span> under given constraints. A model has been found.-->
    <!--                        </span>-->
    <!--                        <span class="result-span display_none" id="UNSAT">-->
    <!--                            The formula is <span class="bold">UNSATISFIABLE</span> under given constraints.-->
    <!--                        </span>-->
    <!--                    </p>-->
    <!--                </div>-->
    <!--                <div class="modal-footer">-->
    <!--                    <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>-->
    <!--                </div>-->
    <!--            </div>-->
    <!--        </div>-->
    <!--    </div>-->
    <div id="errorModal" class="modal fade">
        <div class="modal-dialog modal-confirm">
            <div class="modal-content">
                <div class="modal-header-error">
                    <div class="icon-box">
                        <i class="material-icons">&#xE5CD;</i>
                    </div>
                    <!--                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>-->
                </div>
                <div class="modal-body text-center">
                    <h4>Error!</h4>
                    <p id="errorModalMessage"></p>
                    <button class="btn btn-success" data-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div id="tabs">
            <ul id="tab-ul">
            </ul>
        </div>
        <div class="col-4">
            <form>
                <div class="form-group">
                    <label id="verifierLabel" class="form-label" for="verifiers">Model-checking engine:</label>
                    <select class="custom-select" name="verifier" id="verifiers">
                        <option value="">Embedded</option>
                        <option value="-mcmas-engine">MCMAS</option>
                        <option value="-stv-engine">STV</option>
                    </select>
                </div>
                <div id="model_options">
                    <div id="agentNoDiv" class="form-group">
                        <label id="agentNoLabel" class="form-label" for="agentNo">Number of Agents:</label>
                        <input class="form-control" type="number" min="1" max="5" id="agentNo" value="1"
                               step="1"/>
                    </div>
                </div>
                <hr/>
                <div class="form-group">
                    <label id="atomicPropLabel" class="form-label" for="atomicProp">Number of Atomic
                        Propositions:</label>
                    <input class="form-control" type="number" min="1" id="atomicProp" value="1"
                           step="1"/>
                </div>
                <div class="form-group">
                    <label for="formula" id="formulaLabel">ATL formula to be checked for satisfiability:</label>
                    <textarea class="form-control md-textarea" id="formula"><<0>> F 1</textarea>
                </div>
                <div class="custom-control custom-checkbox">
                    <input id="pdf" type="checkbox" class="custom-control-input"/>
                    <label id="pdfLabel" class="custom-control-label" for="pdf">Generate PDF</label>
                </div>
                <div class="custom-control custom-checkbox">
                    <input id="mcmasCheck" type="checkbox" class="custom-control-input"/>
                    <label id="mcmasCheckLabel" class="custom-control-label" for="mcmasCheck">MCMAS-CHECK</label>
                </div>
                <div>
                    <button type="button" class="btn btn-lg btn-primary" id="btn_generate">Check</button>
                </div>
                <hr/>
                <div class="custom-control custom-checkbox">
                    <input id="showNodeLabels" type="checkbox" class="custom-control-input"/>
                    <label id="showNodeLabelsLabel" class="custom-control-label" for="showNodeLabels">Show State Labels</label>
                </div>
                <div class="custom-control custom-checkbox">
                    <input id="showLabels" type="checkbox" class="custom-control-input"/>
                    <label id="showLabelsLabel" class="custom-control-label" for="showLabels">Show Actions</label>
                </div>
                <div class="row">
                    <div class="col-6">
                        <button type="button" class="btn btn-lg btn-primary" id="btn_zoom_out"><i
                                class="fa fa-search-minus"></i></button>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-lg btn-primary" id="btn_zoom_in"><i
                                class="fa fa-search-plus"></i></button>
                    </div>
                </div>
                <div>
                    <button type="button" class="btn btn-lg btn-primary" id="btn_freeze">Freeze</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
            let $generateButton = $("#btn_generate");
            let $buttonZoomIn = $("#btn_zoom_in");
            let $buttonZoomOut = $("#btn_zoom_out");
            let $buttonFreeze = $("#btn_freeze");
            let $svgGraph = $('#graph');
            let $divGraph = $('#div_graph');
            let $agentNo = $('#agentNo');
            let $modelOptions = $("#model_options");
            let $formula = $('#formula');
            let $atomicProp = $("#atomicProp");
            let $verifier = $("#verifiers");
            let $pdf = $("#pdf");
            let $mcmasCheck = $("#mcmasCheck");
            let scale = 1;
            let models;
            let $errorModal = $("#errorModal");
            let $errorModalMessage = $("#errorModalMessage");

            for (let i = 0; i < 10; i++) {
                $("#tab-ul").append("<li id='tab-" + i + "' class=\"tab-li\" tab_id='" + i + "'><a href=\"#tabs-" + (i + 1) + "\">" + "Label" + i + "</a></li>");
                $("#tabs").append("<div id=\"tabs-" + (i + 1) + "\" class=\"tab-div\">\n" +
                    "                <div class=\"col-8 graph\">\n" +
                    "                    <svg id=\"graph-" + i + "\" width=\"10000\" height=\"10000\">\n" +
                    "                    </svg>\n" +
                    "                </div>\n" +
                    "            </div>");
            }
            $(".tab-li").addClass("display_none");
            $("#tabs").tabs({
                active: 0
            });
            addAgentDiv(0);

            window.scrollTo(4500, 4500);

            $("#showLabels").change(function () {
                if (this.checked) {
                    $(".edgeLabel").removeClass('display_none');
                } else {
                    $(".edgeLabel").addClass('display_none');
                }
            });

        $("#showNodeLabels").change(function () {
            if (this.checked) {
                $(".node_label").removeClass('display_none');
                $(".node_props").removeClass('display_none');
            } else {
                $(".node_label").addClass('display_none');
                $(".node_props").addClass('display_none');
            }
        });

            function saveInput() {
                let fs = require('fs');
                let agentNo = $agentNo.val();
                let input = "p cnf 1 1\n";
                let atomicProp = $atomicProp.val();
                input += "1 0\n\n";

                for (let agentId = 0; agentId < agentNo; agentId++) {
                    let localStates = $('#agentLocalStates-' + agentId).val();
                    let observables = $('#agentObservables-' + agentId).val();
                    if (observables.length > 0) {
                        input += 'kagent ' + agentId + ' ' + localStates + ' observables(' + observables + ')\n';
                    } else {
                        input += 'kagent ' + agentId + ' ' + localStates + '\n';
                    }

                }

                input += '\nkATL ' + atomicProp + ' 1 1 ' + $formula.val() + '\n';

                fs.writeFile('input.txt', input, function (err) {
                    if (err) throw err;
                    console.log('Saved!');
                    run();
                })
            }

            function run() {
                let child = require('child_process').execFile;
                let executablePath = "msatl/msatl";
                let parameters = []; //$verifier.val(),

                if ($verifier.val() !== "") {
                    parameters.push($verifier.val());
                }

                if ($pdf.prop('checked')) {
                    parameters.push("-pdf");
                }

                if ($mcmasCheck.prop('checked')) {
                    parameters.push('-mcmas-check');
                }

                parameters.push("input.txt");

                child(executablePath, parameters, function (err, data) {
                    // if(err){
                    //     console.error(err, data);
                    //     return;
                    // }
                    if (err.code !== 20 && err.code !== 10) {
                        console.log(err.code);
                        console.log(err);
                        console.log(data.toString());
                        if (err.code === 1) {
                            readOutput(false);
                            return;
                        }
                        readOutput(true);
                        return;
                    }
                    readOutput(false);
                });
            }

            function openPdf() {
                const {BrowserWindow} = require('electron').remote;
                const PDFWindow = require('electron-pdf-window');

                const win = new BrowserWindow({width: 800, height: 600});

                PDFWindow.addSupport(win);

                win.loadURL('file://' + __dirname + "/merged.pdf");
            }

            function readOutput(errorOccurred) {
                let fs = require('fs');
                let data = fs.readFileSync('resultFile.stv');

                let json = JSON.parse(data.toString());

                let error = json['error'];

                if (errorOccurred) {
                    resetGraph();
                    let message = "An error has occurred.";
                    $errorModalMessage.text(message);
                    $errorModal.modal();
                    return;
                }

                if (error === true) {
                    resetGraph();
                    let message = json['message'];
                    $errorModalMessage.text(message);
                    $errorModal.modal();
                    return;
                }

                let info = json['info'];

                $(".result-span").addClass('display_none');

                $("#" + info["status"]).removeClass('display_none');

                if (info['status'] === "UNSAT") {
                    resetGraph();
                    $("#resultModal").modal();
                    return;
                }

                // $("#resultSpan").text(info['Status']);
                models = json['models'];


                $(".tab-li").addClass("display_none");

                for (let i = 0; i < models.length; i++) {
                    $("#tab-" + i).removeClass("display_none");
                    $("#tab-" + i + " a").text(models[i].label);
                }

                resetGraph();
                loadGraph(models[0], "graph-0");
                $("#resultModal").modal();
                $("#tabs").tabs("option", "active", 0);

                if ($pdf.prop('checked')) {
                    openPdf();
                }
            }

            $(".tab-li").click(function () {
                console.log($(this).attr("tab_id"));
                $("svg").empty();
                $(".tooltip").remove();
                window.scrollTo(4500, 4500);
                loadGraph(models[$(this).attr("tab_id")], "graph-" + $(this).attr("tab_id"));
            });

            $generateButton.click(function () {
                saveInput();
            });

            $agentNo.change(function () {
                let agentNo = $agentNo.val();

                $('.agentDiv').remove();

                for (let i = 0; i < agentNo; i++) {
                    addAgentDiv(i);
                }
            });

            function addAgentDiv(agentId) {
                let $agentDiv = createAgentDiv(agentId);
                let $agentHeader = createAgentHeader(agentId);
                let $localStatesLabel = createAgentLocalStatesLabel(agentId);
                let $localStatesInput = createAgentLocalStatesInput(agentId);
                let $observablesLabel = createAgentObservablesLabel(agentId);
                let $observablesInput = createAgentObservablesInput(agentId);

                $agentDiv.append($agentHeader);
                $agentDiv.append($localStatesLabel);
                $agentDiv.append($localStatesInput);
                $agentDiv.append($observablesLabel);
                $agentDiv.append($observablesInput);

                $modelOptions.append($agentDiv);
            }

            function createAgentDiv(agentId) {
                let $agentDiv = $("<div></div>");
                $agentDiv.addClass('agentDiv');
                $agentDiv.attr('id', 'agentDiv-' + agentId);
                $agentDiv.addClass('form-group');
                return $agentDiv;
            }

            function createAgentHeader(agentId) {
                let $agentHeader = $("<h5></h5>");
                $agentHeader.text("Agent " + agentId);
                return $agentHeader;
            }

            function createAgentLocalStatesLabel(agentId) {
                let $localStatesLabel = $("<label></label>");
                $localStatesLabel.attr('id', 'agentLocalStatesLabel-' + agentId);
                $localStatesLabel.attr('for', 'agentLocalStates-' + agentId);
                $localStatesLabel.text("Number of Local States:");
                return $localStatesLabel;
            }

            function createAgentLocalStatesInput(agentId) {
                let $localStatesInput = $("<input/>");
                $localStatesInput.attr('id', 'agentLocalStates-' + agentId);
                $localStatesInput.attr('type', 'number');
                $localStatesInput.val(1);
                $localStatesInput.attr('step', 1);
                $localStatesInput.attr('min', 1);
                return $localStatesInput;
            }

            function createAgentObservablesLabel(agentId) {
                let $observablesLabel = $("<label></label>");
                $observablesLabel.attr('id', 'agentObservablesLabel-' + agentId);
                $observablesLabel.attr('for', 'agentObservables-' + agentId);
                $observablesLabel.text("Observables:");
                return $observablesLabel;
            }

            function createAgentObservablesInput(agentId) {
                let $observablesInput = $("<input/>");
                $observablesInput.attr('id', 'agentObservables-' + agentId);
                $observablesInput.attr('type', 'text');
                return $observablesInput;
            }

            $buttonZoomIn.on('click', function () {
                scale += 0.1;
                $("svg").attr('transform', "scale(" + scale + ")");
            });

            $buttonZoomOut.on('click', function () {
                if (scale <= 0.1) {
                    return;
                }

                scale -= 0.1;
                $("svg").attr('transform', "scale(" + scale + ")");
            });

            function resetGraph() {
                $("svg").empty();
                window.scrollTo(4500, 4500);
            }

            function recolorGraph(graph) {
                let nodes = graph.nodes;
                let links = graph.links;
                clearGraphColor();
                colorLinks(links);
                colorNodes(nodes);
            }

            function colorLinks(links) {
                for (let i = 0; i < links.length; i++) {
                    if (links[i]['str'] === 1) {
                        let id = links[i]['id'];
                        $('#link_' + id).attr('stroke', '#F00');
                    }
                }
            }

            function colorNodes(nodes) {
                for (let i = 0; i < nodes.length; i++) {
                    if (nodes[i]['str'] === 1) {
                        let id = nodes[i]['id'];
                        $('#node_' + id).attr('fill', '#0F0');
                    }
                }

                $('.node[initial=true]').attr('fill', '#00F');
                $('.node[winning=true]').attr('fill', '#F0F');
            }

            function clearGraphColor() {
                clearNodesColor();
                clearLinkColor();
            }

            function clearNodesColor() {
                $('g circle').attr('fill', '#CCC');
                $('#node_0').attr('fill', '#00F');
            }

            function clearLinkColor() {
                $('.link').attr('stroke', '#CCC');
            }

            function loadGraph(graph, svgId) {
                let tooltip = d3.select("body")
                    .append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);

                let currNodes = graph.nodes;
                let currLinks = graph.links;

                const svg = d3.select('#' + svgId);
                const width = 10000;
                const height = 10000;

                svg.append('defs');

                let defs = svg.select('defs');

                defs.append('marker')
                    .attr("id", 'arrowhead')
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 19)
                    .attr("refY", 0)
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", "auto")
                    .attr('xoverflow', 'visible')
                    .append('svg:path')
                    .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                    .style('fill', '#999')
                    .style('stroke', 'none');

                defs.append('marker')
                    .attr("id", 'looparrowhead')
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 20)
                    .attr("refY", 1)
                    .attr("markerWidth", 6)
                    .attr("markerHeight", 6)
                    .attr("orient", -170)
                    .attr('xoverflow', 'visible')
                    .append('svg:path')
                    .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                    .style('fill', '#999')
                    .style('stroke', 'none');


                let simulation = d3.forceSimulation()
                    .force("link", d3.forceLink().id(function (d) {
                        return d.id;
                    }).distance(100).strength(1))
                    .force("charge", d3.forceManyBody().strength(-500))
                    .force("center", d3.forceCenter(width / 2, height / 2));

                update(currLinks, currNodes);

                function update(links, nodes) {
                    link = svg.selectAll(".link")
                        .data(links)
                        .enter()
                        .append("path")
                        .attr("class", "link")
                        .attr('marker-end', function (d) {
                            if (d.source === d.target) {
                                return 'url(#looparrowhead)'
                            } else {
                                return 'url(#arrowhead)'
                            }
                        });

                    link.append("title")
                        .text(function (d) {
                            return d.type;
                        });

                    //Add mouseover events to links
                    link.attr('class', 'link')
                        .attr('id', function (d) {
                            return 'link_' + d.id + "-" + svgId;
                        })
                        .on('mouseover.fade', linkFade(0.1))
                        .on('mouseover.tooltip', function (d) {
                            tooltip.transition()
                                .duration(300)
                                .style("opacity", .8);
                            tooltip.html("Source: " + d.source.id +
                                "<br/>Target: " + d.target.id +
                                "<br/>Label: " + d.label)
                                .style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY + 10) + "px");
                        })
                        .on("mouseout.tooltip", function () {
                            tooltip.transition()
                                .duration(100)
                                .style("opacity", 0);
                        })
                        .on('mouseout.fade', linkFade(1))
                        .on("mousemove", function () {
                            tooltip.style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY + 10) + "px");
                        });

                    link.transition().attr('stroke', function (d) {
                        if (d.str === 1) {
                            return "#F00";
                        }

                        return "#CCC";
                    }).attr('stroke-width', '10px');

                    edgepaths = svg.selectAll(".edgepath")
                        .data(links)
                        .enter()
                        .append('path')
                        .attr('class', 'edgepath')
                        .attr('fill-opacity', 0)
                        .attr('stroke-opacity', 0)
                        .attr('id', function (d, i) {
                            return 'edgepath' + i + "-" + svgId
                        })
                        .style("pointer-events", "none");

                    edgelabels = svg.selectAll(".edgelabel")
                        .data(links)
                        .enter()
                        .append('text')
                        .style("pointer-events", "none")
                        .attr('class', function () {
                            if ($("#showLabels").prop('checked')) {
                                return "edgeLabel";
                            } else {
                                return "edgeLabel display_none";
                            }
                        })
                        .attr('id', function (d, i) {
                            return 'edgelabel' + i + "-" + svgId
                        })
                        .attr('font-size', 20)
                        .attr('fill', '#666');

                    edgelabels.append('textPath')
                        .attr('xlink:href', function (d, i) {
                            return '#link_' + d.id + "-" + svgId
                        })
                        .style("text-anchor", "middle")
                        .style("pointer-events", "none")
                        .attr("startOffset", "50%")
                        .text(function (d) {
                            return d.label
                        });

                    node = svg.selectAll(".node")
                        .data(nodes)
                        .enter()
                        .append("g")
                        .attr("class", "node")
                        .call(d3.drag()
                            .on("start", dragstarted)
                            .on("drag", dragged)
                        );

                    node.append("circle")
                        .attr('class', 'node')
                        .attr('id', function (d) {
                            return "node_" + d.id + "-" + svgId
                        })
                        .attr('initial', function (d) {
                            return d.bgn === 1;
                        })
                        .attr('winning', function (d) {
                            return d.win === 1;
                        })
                        .attr("r", 20)
                        .attr("fill", function (d, i) {
                            if (d.id === 0) {
                                return "#00F";
                            }
                            if (d.str === 1) {
                                return "#0F0";
                            }
                            if (d.bgn === 1) {
                                return "#00F";
                            }
                            if (d.win === 1) {
                                return '#F0F';
                            }
                            return "#CCC";
                        })
                        .on('mouseover.tooltip', function (d) {
                            tooltip.transition()
                                .duration(300)
                                .style("opacity", .8);
                            tooltip.html(function () {
                                if (d.props !== undefined) {
                                    return "Node:" + d.id + "<br/>Label:" + d.label + "<br/>Props:[" + d.props + "]";
                                } else {
                                    return "Node:" + d.id + "<br/>Label:" + d.label;
                                }
                            })
                                .style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY + 10) + "px");
                        })
                        .on('mouseover.fade', fade(0.1))
                        .on("mouseout.tooltip", function () {
                            tooltip.transition()
                                .duration(100)
                                .style("opacity", 0);
                        })
                        .on('mouseout.fade', fade(1))
                        .on("mousemove", function () {
                            tooltip.style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY + 10) + "px");
                        });

                    // node.append("title")
                    //     .text(function (d) {return d.id;});

                    // node.append("text")
                    //     .attr("dy", -3)
                    //     .text(function (d) {return d.id;});

                    node.append("text")
                        .attr("text-anchor", "middle")
                        .attr("dy", ".3em").html(function (d) {
                        return d.id;
                        // if(d.props !== undefined){
                        //     return d.id + "<span class='node_text'><br/>Label:" + d.label + "<br/>Props:[" + d.props + "]</span>";
                        // } else {
                        //     return d.id + "<span class='node_text'><br/>Label:" + d.label + "</span>";
                        // }
                    });

                    node.append("text")
                        .attr("dy", 35)
                        .attr('dx', -20)
                        .attr('class', function() {
                            if ($("#showNodeLabels").prop('checked')) {
                                return "node_label";
                            } else {
                                return "node_label display_none";
                            }
                        })
                        .html(function (d) {
                            return "Label: " + d.label;
                        });

                    node.append("text")
                        .attr("dy", 55)
                        .attr('dx', -20)
                        .attr('class', function() {
                            if ($("#showNodeLabels").prop('checked')) {
                                return "node_props";
                            } else {
                                return "node_props display_none";
                            }
                        })
                        .html(function (d) {
                            if(d.props === undefined) {
                                return "";
                            }

                            return "Props: [" + d.props + "]";
                        });

                    _.each(links, function (link) {

                        // find other links with same target+source or source+target
                        let same = _.filter(links, {
                            'source': link.source,
                            'target': link.target
                        });
                        let sameAlt = _.filter(links, {
                            'source': link.target,
                            'target': link.source
                        });
                        let sameAll = same.concat(sameAlt);

                        _.each(sameAll, function (s, i) {
                            s.sameIndex = (i + 1);
                            s.sameTotal = sameAll.length;
                            s.sameTotalHalf = (s.sameTotal / 2);
                            s.sameUneven = ((s.sameTotal % 2) !== 0);
                            s.sameMiddleLink = ((s.sameUneven === true) &&
                                (Math.ceil(s.sameTotalHalf) === s.sameIndex));
                            s.sameLowerHalf = (s.sameIndex <= s.sameTotalHalf);
                            s.sameArcDirection = s.sameLowerHalf ? 0 : 1;
                            s.sameIndexCorrected = s.sameLowerHalf ? s.sameIndex : (s.sameIndex - Math.ceil(s.sameTotalHalf));
                        });
                    });

                    let maxSame = _.chain(links)
                        .sortBy(function (x) {
                            return x.sameTotal;
                        })
                        .last()
                        .value().sameTotal;

                    _.each(links, function (link) {
                        link.maxSameHalf = Math.round(maxSame / 2);
                    });

                    simulation
                        .nodes(nodes)
                        .on("tick", ticked);

                    simulation.force("link")
                        .links(links);
                }

                function dragstarted(d) {
                    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function dragged(d) {
                    d.fx = d3.event.x;
                    d.fy = d3.event.y;
                }

                function ticked() {
                    link.attr("d", linkArc);

                    node
                        .attr("transform", function (d) {
                            return "translate(" + d.x + ", " + d.y + ")";
                        });

                    edgepaths.attr('d', function (d) {
                        return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
                    });

                    edgelabels.attr('transform', function (d) {
                        if (d.target.x < d.source.x) {
                            var bbox = this.getBBox();

                            rx = bbox.x + bbox.width / 2;
                            ry = bbox.y + bbox.height / 2;
                            return 'rotate(180 ' + rx + ' ' + ry + ')';
                        } else {
                            return 'rotate(0)';
                        }
                    });
                }


                function linkArc(d) {
                    var dx = (d.target.x - d.source.x),
                        dy = (d.target.y - d.source.y),
                        dr = Math.sqrt(dx * dx + dy * dy),
                        unevenCorrection = (d.sameUneven ? 0 : 0.5);
                    var curvature = 2,
                        arc = (1.0 / curvature) * ((dr * d.maxSameHalf) / (d.sameIndexCorrected - unevenCorrection));

                    if (d.sameMiddleLink) {
                        arc = 0;
                    }

                    if (d.target.x === d.source.x && d.target.y === d.source.y) {
                        var x1 = d.source.x,
                            y1 = d.source.y,
                            x2 = d.target.x,
                            y2 = d.target.y,
                            // Defaults for normal edge.
                            drx = dr,
                            dry = dr,
                            xRotation = 0, // degrees
                            largeArc = 0, // 1 or 0
                            sweep = 1; // 1 or 0

                        // Fiddle with this angle to get loop oriented.
                        xRotation = -45;

                        // Needs to be 1.
                        largeArc = 1;

                        // Change sweep to change orientation of loop.
                        //sweep = 0;

                        // Make drx and dry different to get an ellipse
                        // instead of a circle.
                        drx = 30;
                        dry = 30;

                        // For whatever reason the arc collapses to a point if the beginning
                        // and ending points of the arc are the same, so kludge it.
                        x2 = x2 + 0.1;
                        y2 = y2 + 0.1;

                        return "M" + x1 + "," + y1 + "A" + drx + "," + dry + " " + xRotation + "," + largeArc + "," + sweep + " " + x2 + "," + y2;
                    }


                    return "M" + d.source.x + "," + d.source.y + "A" + arc + "," + arc + " 0 0," + d.sameArcDirection + " " + d.target.x + "," + d.target.y;
                }

                const linkedByIndex = {};
                currLinks.forEach(d => {
                    linkedByIndex[`${d.source.index},${d.target.index}`] = 1;
                });

                function isConnected(a, b) {
                    return linkedByIndex[`${a.index},${b.index}`] || linkedByIndex[`${b.index},${a.index}`] || a.index === b.index;
                }

                function fade(opacity) {
                    return d => {
                        node.style('stroke-opacity', function (o) {
                            const thisOpacity = isConnected(d, o) ? 1 : opacity;
                            this.setAttribute('fill-opacity', thisOpacity);
                            return thisOpacity;
                        });

                        link.style('stroke-opacity', o => (o.source === d || o.target === d ? 1 : opacity));

                    };
                }

                function linkFade(opacity) {
                    return d => {
                        node.style('stroke-opacity', function (o) {
                            const thisOpacity = isConnected(d.source, o) && isConnected(d.target, o) ? 1 : opacity;
                            this.setAttribute('fill-opacity', thisOpacity);
                            return thisOpacity;
                        });

                        link.style('stroke-opacity', o => (o.source === d.source && o.target === d.target ? 1 : opacity));
                    }
                }

                $buttonFreeze.off('click');
                $buttonFreeze.on('click', function () {
                    _.each(currNodes, function (nd) {
                        nd.fx = nd.x;
                        nd.fy = nd.y;
                    });
                });
            }


            // readOutput(false);
        }
    );


</script>
</body>
</html>


<!--<marker id="arrowhead" viewBox="0 -5 10 10" refX="20" refY="1" markerWidth="6" markerHeight="6" orient="-170" xoverflow="visible"><path d="M 0,-5 L 10 ,0 L 0,5" style="fill: rgb(153, 153, 153); stroke: none;"></path></marker>-->