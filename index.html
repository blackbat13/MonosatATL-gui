<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>STV v0.0.1</title>
    <script>if (typeof module === 'object') {
        window.module = module;
        module = undefined;
    }</script>
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script>if (window.module) module = window.module;</script>
    <link href="css/main.css" type="text/css" rel="stylesheet"/>
    <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" type="text/css" rel="stylesheet"/>
    <link href="node_modules/font-awesome/css/font-awesome.min.css" type="text/css" rel="stylesheet">
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="node_modules/d3/dist/d3.js"></script>
    <script src="node_modules/lodash/lodash.min.js"></script>
    <script src="node_modules/graphlib-dot/dist/graphlib-dot.min.js"></script>
    <script src="node_modules/dagre-d3/dist/dagre-d3.js"></script>
<!--    <script src="https://dagrejs.github.io/project/dagre-d3/v0.5.0/dagre-d3.js"></script>-->
</head>
<body>
<div class="container-fluid">
    <!-- Modal -->
    <div class="modal fade" id="upperApproxModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Verification finished</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>The formula: <span id="lowerApproxModalFormula"></span></p>
                    <p>Verification result: the formula <span id="upperApproxTrue">might hold</span><span
                            id="upperApproxFalse">does not hold</span> in the model</p>
                    <p>Number of states where formula might hold: <span id="upperApproxNoStates"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div id="div_graph" class="col-8">
            <svg id="graph" width="10000" height="10000">

            </svg>
        </div>
        <div class="col-4">
            <form>
                <div class="form-group">
                    <label id="verifierLabel" class="form-label" for="verifiers">Verifier:</label>
                    <select name="verifier" id="verifiers">
                        <option value="stv">STV</option>
                        <option value="mcmas">MCMAS</option>
                    </select>
                </div>
                <div id="model_options">
                    <div id="agentNoDiv" class="form-group">
                        <label id="agentNoLabel" class="form-label" for="agentNo">Number of Agents:</label>
                        <input class="form-control" type="number" min="1" max="5" id="agentNo" value="1"
                               step="1"/>

                    </div>

                </div>
                <hr/>
                <div>
                    <label for="formula" id="formulaLabel">Formula to be verified:</label>
                    <input type="text" id="formula" value="<<0,1>> F 1"/>
                </div>
                <div>
                    <button type="button" class="btn btn-lg btn-primary" id="btn_generate">Generate</button>
                </div>
                <hr/>
                <div class="row">
                    <div class="col-6">
                        <button type="button" class="btn btn-lg btn-primary" id="btn_zoom_out"><i
                                class="fa fa-search-minus"></i></button>
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-lg btn-primary" id="btn_zoom_in"><i
                                class="fa fa-search-plus"></i></button>
                    </div>
                </div>
                <div>
                    <button type="button" class="btn btn-lg btn-primary" id="btn_freeze">Freeze</button>
                </div>
                <div>
                    <a href="https://github.com/blackbat13/StraTegicVerifier" target="_blank">
                        <button type="button" class="btn btn-lg btn-info" id="btn_source">Source</button>
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        let $generateButton = $("#btn_generate");
        let $buttonZoomIn = $("#btn_zoom_in");
        let $buttonZoomOut = $("#btn_zoom_out");
        let $buttonFreeze = $("#btn_freeze");
        let $svgGraph = $('#graph');
        let $divGraph = $('#div_graph');
        let $agentNo = $('#agentNo');
        let $modelOptions = $("#model_options");
        let $formula = $('#formula');
        let scale = 1;

        addAgentDiv(0);

        window.scrollTo(3800, 3800);

        function saveInput() {
            let fs = require('fs');
            let agentNo = $agentNo.val();
            let input = "p cnf 1 1\n";
            input += "1 0\n\n";

            for(let agentId = 0; agentId < agentNo; agentId++) {
                let localStates = $('#agentLocalStates-'+agentId).val();
                let observables = $('#agentObservables-'+agentId).val();
                input += 'kagent ' + agentId + ' ' + localStates + ' observables(' + observables + ")\n";
            }

            input += '\nkATL 3 1 1 ' + $formula.val() + '\n';

            fs.writeFile('input.txt', input, function(err) {
                if (err) throw err;
                console.log('Saved!');
            })
        }

        readOutput();

        function readOutput() {
            let fs = require('fs');
            let parse = require('dotparser');
            let data = fs.readFileSync('out.txt');
            // console.log(data.toString().split('digraph'));
            let digraphs = data.toString().split('digraph');
            // for(let i = 1; i < digraphs.length; i++) {
            //     let ast = parse('digraph' + digraphs[i]);
            //     console.log(ast);
            // }

            let ast = parse('digraph' + digraphs[1]);
            //console.log(ast[0].children);
            // for(let i = 0; i < ast[0].children.length; i++) {
            //     console.log(ast[0].children[i]);
            // }

            //createGraph(ast[0]);
            loadDotGraph('digraph' + digraphs[1]);
        }

        function createGraph(dot) {
            let nodes = [];
            let links = [];
            for(let i = 0; i < dot.children.length; i++) {
                // console.log(dot.children[i]);
                let child = dot.children[i];
                console.log(child);
                if(child.type === 'node_stmt') {
                    nodes.push({'T': child.node_id.id, 'id': child.node_id.id});
                } else if(child.type === 'edge_stmt') {
                    let t = "";
                    if(child.attr_list.length > 0) {
                        t = child.attr_list[0].eq;
                    }
                    links.push({'id': i, 'source': child.edge_list[0].id, 'target':child.edge_list[1].id, "T": t});
                }
            }

            console.log(nodes);
            console.log(links);
            let graph = {'nodes': nodes, 'links':links};
            loadGraph(graph);
        }

        $generateButton.click(function(){
            saveInput();
        });

        $agentNo.change(function () {
            let agentNo = $agentNo.val();

            $('.agentDiv').remove();

            for (let i = 0; i < agentNo; i++) {
                addAgentDiv(i);
            }
        });

        function addAgentDiv(agentId) {
            let $agentDiv = createAgentDiv(agentId);
            let $agentHeader = createAgentHeader(agentId);
            let $localStatesLabel = createAgentLocalStatesLabel(agentId);
            let $localStatesInput = createAgentLocalStatesInput(agentId);
            let $observablesLabel = createAgentObservablesLabel(agentId);
            let $observablesInput = createAgentObservablesInput(agentId);

            $agentDiv.append($agentHeader);
            $agentDiv.append($localStatesLabel);
            $agentDiv.append($localStatesInput);
            $agentDiv.append($observablesLabel);
            $agentDiv.append($observablesInput);

            $modelOptions.append($agentDiv);
        }

        function createAgentDiv(agentId) {
            let $agentDiv = $("<div></div>");
            $agentDiv.addClass('agentDiv');
            $agentDiv.attr('id', 'agentDiv-' + agentId);
            $agentDiv.addClass('form-group');
            return $agentDiv;
        }

        function createAgentHeader(agentId) {
            let $agentHeader = $("<h5></h5>");
            $agentHeader.text("Agent " + agentId);
            return $agentHeader;
        }

        function createAgentLocalStatesLabel(agentId) {
            let $localStatesLabel = $("<label></label>");
            $localStatesLabel.attr('id', 'agentLocalStatesLabel-' + agentId);
            $localStatesLabel.attr('for', 'agentLocalStates-' + agentId);
            $localStatesLabel.text("Number of Local States:");
            return $localStatesLabel;
        }

        function createAgentLocalStatesInput(agentId) {
            let $localStatesInput = $("<input/>");
            $localStatesInput.attr('id', 'agentLocalStates-' + agentId);
            $localStatesInput.attr('type', 'number');
            $localStatesInput.val(1);
            $localStatesInput.attr('step', 1);
            $localStatesInput.attr('min', 1);
            return $localStatesInput;
        }

        function createAgentObservablesLabel(agentId) {
            let $observablesLabel = $("<label></label>");
            $observablesLabel.attr('id', 'agentObservablesLabel-' + agentId);
            $observablesLabel.attr('for', 'agentObservables-' + agentId);
            $observablesLabel.text("Observables:");
            return $observablesLabel;
        }

        function createAgentObservablesInput(agentId) {
            let $observablesInput = $("<input/>");
            $observablesInput.attr('id', 'agentObservables-' + agentId);
            $observablesInput.attr('type', 'text');
            return $observablesInput;
        }

        $buttonZoomIn.on('click', function () {
            scale += 0.1;
            $("svg").attr('transform', "scale(" + scale + ")");
        });

        $buttonZoomOut.on('click', function () {
            if (scale <= 0.1) {
                return;
            }

            scale -= 0.1;
            $("svg").attr('transform', "scale(" + scale + ")");
        });

        function resetGraph() {
            $svgGraph.empty();
            window.scrollTo(4500, 4500);
        }

        function recolorGraph(graph) {
            let nodes = graph.nodes;
            let links = graph.links;
            clearGraphColor();
            colorLinks(links);
            colorNodes(nodes);
        }

        function colorLinks(links) {
            for (let i = 0; i < links.length; i++) {
                if (links[i]['str'] === 1) {
                    let id = links[i]['id'];
                    $('#link_' + id).attr('stroke', '#F00');
                }
            }
        }

        function colorNodes(nodes) {
            for (let i = 0; i < nodes.length; i++) {
                if (nodes[i]['str'] === 1) {
                    let id = nodes[i]['id'];
                    $('#node_' + id).attr('fill', '#0F0');
                }
            }

            $('.node[initial=true]').attr('fill', '#00F');
            $('.node[winning=true]').attr('fill', '#F0F');
        }

        function clearGraphColor() {
            clearNodesColor();
            clearLinkColor();
        }

        function clearNodesColor() {
            $('g circle').attr('fill', '#CCC');
            $('#node_0').attr('fill', '#00F');
        }

        function clearLinkColor() {
            $('.link').attr('stroke', '#CCC');
        }

        function loadDotGraph(digraph) {
            var g = graphlibDot.read(digraph);
            console.log(g);
            var render = new dagreD3.render();
            render(d3.select("svg"), g);
        }

        function loadGraph(graph) {
            let tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            let currNodes = graph.nodes;
            let currLinks = graph.links;

            const svg = d3.select('svg');
            const width = 10000;
            const height = 10000;

            svg.append('defs').append('marker')
                .attr("id", 'arrowhead')
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 19)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .attr('xoverflow', 'visible')
                .append('svg:path')
                .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                .style('fill', '#999')
                .style('stroke', 'none');


            let simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(function (d) {
                    return d.id;
                }).distance(100).strength(1))
                .force("charge", d3.forceManyBody().strength(-500))
                .force("center", d3.forceCenter(width / 2, height / 2));

            update(currLinks, currNodes);

            function update(links, nodes) {
                link = svg.selectAll(".link")
                    .data(links)
                    .enter()
                    .append("path")
                    .attr("class", "link")
                    .attr('marker-end', 'url(#arrowhead)');

                link.append("title")
                    .text(function (d) {
                        return d.type;
                    });

                //Add mouseover events to links
                link.attr('class', 'link')
                    .attr('id', function (d) {
                        return 'link_' + d.id;
                    })
                    .on('mouseover.fade', linkFade(0.1))
                    .on('mouseover.tooltip', function (d) {
                        tooltip.transition()
                            .duration(300)
                            .style("opacity", .8);
                        tooltip.html("Source:" + d.source.id +
                            "<p/>Target:" + d.target.id +
                            "<p/>T:" + d.T)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY + 10) + "px");
                    })
                    .on("mouseout.tooltip", function () {
                        tooltip.transition()
                            .duration(100)
                            .style("opacity", 0);
                    })
                    .on('mouseout.fade', linkFade(1))
                    .on("mousemove", function () {
                        tooltip.style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY + 10) + "px");
                    });

                link.transition().attr('stroke', function (d) {
                    if (d.str === 1) {
                        return "#F00";
                    }

                    return "#CCC";
                }).attr('stroke-width', '10px');

                edgepaths = svg.selectAll(".edgepath")
                    .data(links)
                    .enter()
                    .append('path')
                    .attr('class', 'edgepath')
                    .attr('fill-opacity', 1)
                    .attr('stroke-opacity', 1)
                    .attr('id', function (d, i) {
                        return 'edgepath' + i
                    })
                    .style("pointer-events", "none");

                node = svg.selectAll(".node")
                    .data(nodes)
                    .enter()
                    .append("g")
                    .attr("class", "node")
                    .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                    );

                node.append("circle")
                    .attr('class', 'node')
                    .attr('id', function (d) {
                        return "node_" + d.id
                    })
                    .attr('initial', function (d) {
                        return d.bgn === 1;
                    })
                    .attr('winning', function (d) {
                        return d.win === 1;
                    })
                    .attr("r", 20)
                    .attr("fill", function (d, i) {
                        if (d.id === 0) {
                            return "#00F";
                        }
                        if (d.str === 1) {
                            return "#0F0";
                        }
                        if (d.bgn === 1) {
                            return "#00F";
                        }
                        if (d.win === 1) {
                            return '#F0F';
                        }
                        return "#CCC";
                    })
                    .on('mouseover.tooltip', function (d) {
                        tooltip.transition()
                            .duration(300)
                            .style("opacity", .8);
                        tooltip.html("Node:" + d.id + "<p/>T:" + JSON.stringify(d.T))
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY + 10) + "px");
                    })
                    .on('mouseover.fade', fade(0.1))
                    .on("mouseout.tooltip", function () {
                        tooltip.transition()
                            .duration(100)
                            .style("opacity", 0);
                    })
                    .on('mouseout.fade', fade(1))
                    .on("mousemove", function () {
                        tooltip.style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY + 10) + "px");
                    });

                node.append("text")
                    .attr("text-anchor", "middle")
                    .attr("dy", ".3em").text(function (d) {
                    return d.id
                });

                _.each(links, function (link) {

                    // find other links with same target+source or source+target
                    let same = _.filter(links, {
                        'source': link.source,
                        'target': link.target
                    });
                    let sameAlt = _.filter(links, {
                        'source': link.target,
                        'target': link.source
                    });
                    let sameAll = same.concat(sameAlt);

                    _.each(sameAll, function (s, i) {
                        s.sameIndex = (i + 1);
                        s.sameTotal = sameAll.length;
                        s.sameTotalHalf = (s.sameTotal / 2);
                        s.sameUneven = ((s.sameTotal % 2) !== 0);
                        s.sameMiddleLink = ((s.sameUneven === true) &&
                            (Math.ceil(s.sameTotalHalf) === s.sameIndex));
                        s.sameLowerHalf = (s.sameIndex <= s.sameTotalHalf);
                        s.sameArcDirection = s.sameLowerHalf ? 0 : 1;
                        s.sameIndexCorrected = s.sameLowerHalf ? s.sameIndex : (s.sameIndex - Math.ceil(s.sameTotalHalf));
                    });
                });

                let maxSame = _.chain(links)
                    .sortBy(function (x) {
                        return x.sameTotal;
                    })
                    .last()
                    .value().sameTotal;

                _.each(links, function (link) {
                    link.maxSameHalf = Math.round(maxSame / 2);
                });

                simulation
                    .nodes(nodes)
                    .on("tick", ticked);

                simulation.force("link")
                    .links(links);
            }

            function dragstarted(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function ticked() {
                link.attr("d", linkArc);

                node
                    .attr("transform", function (d) {
                        return "translate(" + d.x + ", " + d.y + ")";
                    });

                edgepaths.attr('d', function (d) {
                    return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
                });
            }

            function linkArc(d) {
                var dx = (d.target.x - d.source.x),
                    dy = (d.target.y - d.source.y),
                    dr = Math.sqrt(dx * dx + dy * dy),
                    unevenCorrection = (d.sameUneven ? 0 : 0.5);
                var curvature = 2,
                    arc = (1.0 / curvature) * ((dr * d.maxSameHalf) / (d.sameIndexCorrected - unevenCorrection));

                if (d.sameMiddleLink) {
                    arc = 0;
                }

                return "M" + d.source.x + "," + d.source.y + "A" + arc + "," + arc + " 0 0," + d.sameArcDirection + " " + d.target.x + "," + d.target.y;
            }

            const linkedByIndex = {};
            currLinks.forEach(d => {
                linkedByIndex[`${d.source.index},${d.target.index}`] = 1;
            });

            function isConnected(a, b) {
                return linkedByIndex[`${a.index},${b.index}`] || linkedByIndex[`${b.index},${a.index}`] || a.index === b.index;
            }

            function fade(opacity) {
                return d => {
                    node.style('stroke-opacity', function (o) {
                        const thisOpacity = isConnected(d, o) ? 1 : opacity;
                        this.setAttribute('fill-opacity', thisOpacity);
                        return thisOpacity;
                    });

                    link.style('stroke-opacity', o => (o.source === d || o.target === d ? 1 : opacity));

                };
            }

            function linkFade(opacity) {
                return d => {
                    node.style('stroke-opacity', function (o) {
                        const thisOpacity = isConnected(d.source, o) && isConnected(d.target, o) ? 1 : opacity;
                        this.setAttribute('fill-opacity', thisOpacity);
                        return thisOpacity;
                    });

                    link.style('stroke-opacity', o => (o.source === d.source && o.target === d.target ? 1 : opacity));
                }
            }

            $buttonFreeze.off('click');
            $buttonFreeze.on('click', function () {
                _.each(currNodes, function (nd) {
                    nd.fx = nd.x;
                    nd.fy = nd.y;
                });
            });
        }
    });


</script>
</body>
</html>